
<style>
    .nav-tabs .nav-link {
        color: #333 !important;
        font-weight: 500;
        border: none !important;
    }

        .nav-tabs .nav-link.active {
            color: #008d94 !important;
            border-bottom: 2px solid #008d94 !important;
            background: transparent !important;
        }
</style>

<style>
    /* ===== LAYOUT ===== */
    .workrecord-wrapper {
        display: flex;
        gap: 16px;
        width: 100%;
        align-items: stretch;
    }

    /* ===== COMMON CARD ===== */
    .wr-card {
        background: #f6f6f6;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    /* ===== WIDTH CONTROL ===== */
    .wr-profile {
        flex: 1.4;
    }

    .wr-tag {
        flex: 1.0;
    }

    .wr-shift {
        flex: 1.6;
    }

    /* ===== HEIGHT CONTROL ===== */
    .wr-profile,
    .wr-tag,
    .wr-shift {
        min-height: 130px;
        
    }

    /* ===== PROFILE ===== */
/*     .wr-profile {
        flex-direction: row;
        gap: 14px;
        align-items: center;
    } */
    .wr-profile {
        display: flex;
        flex-direction: column; /* 🔥 row → column */
        gap: 12px;
    }

    .wr-profile-top {
        display: flex;
        flex-direction: row;
        gap: 14px;
        align-items: center;
    }


    .wr-avatar {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        border: 3px solid #dfd6ff;
    }

   /*  .wr-profile-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    } */
    .wr-profile-content {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .wr-name {
        font-weight: 600;
    }

    .wr-date {
        font-size: 13px;
        color: #6c757d;
    }

    /* note container */
    .wr-notes-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        max-width: 400px;
    }

    /* Static Notes label */
    .notes-label {
        font-weight: bold;
        flex-shrink: 0;
    }

    /* Scrollable content container */
    .notes-content-wrapper {
        max-height: 45px;
        overflow-y: auto;
       /*  flex-grow: 1; */
        font-size: 13px;
    }

    /* Actual notes text */
    .notes-text {
        word-break: break-word;
        white-space: pre-wrap; 
        margin-top: 4px;
    }

        /* Placeholder styling */
        .notes-text.placeholder {
            color: #999;
            font-style: italic;
        }

    /* Pencil icon */
    .wr-icon-btn {
        flex-shrink: 0;
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 5px;
        align-self: flex-start;
    }



    /* ===== TAG / EMPLOYEE ===== */
    .wr-label {
        font-size: 13px;
        font-weight: 500;
    }

    .wr-select {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }

    /* ===== SHIFT ===== */
    .wr-shift-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    /* ===== MOBILE ===== */
    @@media (max-width: 992px) {
        .workrecord-wrapper {
            flex-direction: column;
        }
    }
</style>
<style>
    .input-select select {
        padding: 8px 12px !important;
        height: 35px !important;
        width: 100% !important;
    }
</style>

<style>
    .btn-today {
        border-color: #2b4d83;
        color: black;
        transition: background-color 0.2s, color 0.2s;
    }

        .btn-today:hover,
        .btn-today:focus,
        .btn-today:active {
            background-color: #3560a5; 
            border-color: #2b4d83;
            color: white;
        }
</style>

<div class="modal fade right" id="workRecordNotesModel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl modal-right" style="width:85vw">
        <div class="modal-content h-100 border-0">

            <EditForm Model="@createEditWorkRecordsNotesModel" class="d-flex flex-column h-100">
                <DataAnnotationsValidator />

                <!-- Header-->
              @*   <div class="modal-header border-0">
                    <h5> @((createEditWorkRecordsNotesModel.Id == 0) ? "Create Work Record" : "Edit Work Record") </h5>
                    <div class="d-flex align-items-center gap-2 ms-auto">
                        <button class="btn" @onclick="PreviousDay">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                        <button class="btn" @onclick="Today">Today</button>
                        <button class="btn" @onclick="NextDay" style="margin-right: -15px; ">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-right: -20px; "></button>
                    </div>
                </div> *@
                <div class="modal-header border-0 d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        @((createEditWorkRecordsNotesModel.Id == 0) ? "Create Work Record" : "Edit Work Record")
                    </h5>

                    <div class="d-flex align-items-center gap-2">
                  @*       <!-- Previous Button -->
                        <button class="btn btn-outline-secondary" @onclick="PreviousDay" title="Previous Day">
                            <i class="bi bi-chevron-left"></i>
                        </button>

                        <!-- Today Button -->
                        <button class="btn btn-today" @onclick="Today" title="Today">
                            Today
                        </button>

                        <!-- Next Button -->
                        <button class="btn btn-outline-secondary " @onclick="NextDay" title="Next Day">
                            <i class="bi bi-chevron-right"></i>
                        </button> *@

                        <!-- Close Button -->
                        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>


                <!-- Body-->
                <div class="modal-body overflow-auto flex-grow-1" style="max-height: 90vh; margin-top: -15px;">

                    <div class="workrecord-wrapper">

                        <!-- PROFILE -->
                       @*  <div class="wr-card wr-profile">
                            <div class="wr-avatar">
                                <img src="@GetEmployeeImage()" class="img-fluid rounded-circle" style="width: 100%; height: 100%; object-fit: cover;" />
                            </div>

                            <div class="wr-profile-content">
                                <div class="wr-name">@createEditWorkRecordsNotesModel.WorkDetails.EmployeeName</div>
                                <div class="wr-date">@createEditWorkRecordsNotesModel?.WorkDetails?.ShiftDateDisplay</div>

                                <div class="wr-notes-wrapper">
                                    <span class="notes-label">Notes:</span>

                                    <div class="notes-content-wrapper">
                                        @if (!string.IsNullOrWhiteSpace(createEditWorkRecordsNotesModel?.Notes))
                                        {
                                            <div class="notes-text">@createEditWorkRecordsNotesModel.WorkDetails.Notes</div>
                                        }      
                                    </div>

                                    <button class="wr-icon-btn" @onclick="CreateEditNotes" disabled="@locked" style="cursor:@(locked ? "not-allowed" : "pointer")">✏️</button>
                                </div>

                               <div class="align-bottom col-md-12">
                                   <div class="col-6">

                                   </div>
                               </div>

                           </div>
                        </div> *@

                        <div class="wr-card wr-profile">

                            <!--  Avatar + Name + Notes -->
                            <div class="wr-profile-top">

                                <div class="wr-avatar">
                                    <img src="@GetEmployeeImage()" class="img-fluid rounded-circle" style="width: 100%; height: 100%; object-fit: cover;" />
                                </div>

                                <div class="wr-profile-content">
                                    <div class="wr-name"> @createEditWorkRecordsNotesModel.WorkDetails.EmployeeName
                                    </div>

                                    <div class="wr-date">
                                        @createEditWorkRecordsNotesModel?.WorkDetails?.ShiftDateDisplay
                                    </div>
                                
                                    <div class="wr-notes-wrapper">
                                        <span class="notes-label">Notes:</span>

                                        <div class="notes-content-wrapper">
                                            @if (!string.IsNullOrWhiteSpace(createEditWorkRecordsNotesModel?.Notes))
                                            {
                                                <div class="notes-text">@createEditWorkRecordsNotesModel.WorkDetails.Notes</div>
                                            }
                                        </div>

                                        <button class="wr-icon-btn" title="Create/Edit Notes" @onclick="CreateEditNotes" disabled="@locked" style="cursor:@(locked ? "not-allowed" : "pointer")">✏️</button>
                                    </div>
                                </div>
                            </div>

                            <!-- DAY NAV BUTTONS -->
                            <div class="mt-auto" style="margin-bottom: -10px;">
                                <div class="d-flex gap-2 justify-content-end">

                                    <button class="btn btn-outline-secondary"
                                            @onclick="PreviousDay"
                                            title="Previous Day">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>

                                    <button class="btn btn-today"
                                            @onclick="Today"
                                            title="Today">
                                        Today
                                    </button>

                                    <button class="btn btn-outline-secondary"
                                            @onclick="NextDay"
                                            title="Next Day">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>

                                </div>
                            </div>

                        </div>


                        <!-- TAG & EMPLOYEE dropdown-->
                        <div class="wr-card wr-tag">

                            <div class="input-select">
                                <label class="form-label body-medium">Tag</label>
                                <select value="@tagId" @onchange="OnTagChanged" class="form-select form-control-lg body-medium  no-outline">
                                    @foreach (var tag in tagList)
                                    {
                                        <option value="@tag.Id">@tag.Name</option>
                                    }
                                </select>
                            </div>

                            <div class="input-select">
                                <label class="form-label body-medium mt-2">Employee</label>
                                <select value="@EmployeeId" @onchange="OnEmployeeChanged" class="form-select form-control-lg body-medium  no-outline">
                                    @foreach (var employee in employees)
                                    {
                                        <option value="@employee.Id">@employee.FullName</option>
                                    }
                                </select>
                            </div>

                        </div>

                        <!-- SHIFT -->
                        <div class="wr-card wr-shift" style="background: none; padding:0;">
                            <div class="wr-shift-header">
                               
                            </div>
                            <CreateEditWorkRecordShiftTab employeeShift="createEditWorkRecordsNotesModel?.WorkDetails.EmployeeShifts"
                                                          EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                          ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" />
                        </div>

                    </div>


                    <div class=" p-1 pt-4 body-medium">
                        <ul class="nav nav-tabs mb-3">

                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "workRecordsTab" ? "active" : "")" href="#workRecordsTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("workRecordsTab"))">Work Record</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "overtimeTab" ? "active" : "")" href="#overtimeTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("overtimeTab"))">Overtime</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "absenceTab" ? "active" : "")" href="#absenceTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("absenceTab"))">Absence</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "exceptionTab" ? "active" : "")" href="#exceptionTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("exceptionTab"))">Exceptions</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "exceptionalItemTab" ? "active" : "")" href="#exceptionalItemTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("exceptionalItemTab"))">Exceptional Item</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "accessMovementTab" ? "active" : "")" href="#accessMovementTab" data-bs-toggle="tab" @onclick="@(() => OnTabClick("accessMovementTab"))">Access Movement Records</a>
                            </li>

                        </ul>

                        <div class="tab-content p-0 bg-transparent">

                            <div class="tab-pane fade @(activeTab == "workRecordsTab" ? "show active" : "")" id="workRecordsTab">
                                <CreateEditWorkRecordsTab workRecords="createEditWorkRecordsNotesModel?.WorkDetails.WorkRecords"
                                                          EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                          ReloadWorkRecordAsync="ReloadWorkRecordAsync" late="late" locked="locked" />
                                <div class="mt-3">
                                    <CreateEditRealClockingTab realClockings="createEditWorkRecordsNotesModel?.WorkDetails.RealClockings"
                                                               EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                               ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" verified="verified" />
                                </div>
                            </div>
                            <div class="tab-pane fade @(activeTab == "overtimeTab" ? "show active" : "")" id="overtimeTab">
                                <CreateEditWorkRecordOvertimeTab overtime="createEditWorkRecordsNotesModel?.WorkDetails.Overtime"
                                                                 EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                                 ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" />
                            </div>

                            <div class="tab-pane fade @(activeTab == "absenceTab" ? "show active" : "")" id="absenceTab"> 
                                <CreateEditWorkRecordAbsenceTab absenteeRecord="createEditWorkRecordsNotesModel?.WorkDetails.Absence"
                                                                EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                                ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" />
                            </div>

                            <div class="tab-pane fade @(activeTab == "exceptionTab" ? "show active" : "")" id="exceptionTab">
                                <CreateEditWorkRecordExceptionsTab exceptions="createEditWorkRecordsNotesModel?.WorkDetails.Exceptions"
                                                                   ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" />
                            </div>

                            <div class="tab-pane fade @(activeTab == "exceptionalItemTab" ? "show active" : "")" id="exceptionalItemTab">
                                <CreateEdirWorkRecordExceptionalItemsTab exceptionalItem="createEditWorkRecordsNotesModel?.WorkDetails.ExceptionalItems"
                                                                         EmployeeId="EmployeeId" shiftDate="shiftDate" employeeShiftId="employeeShiftId"
                                                                         ReloadWorkRecordAsync="ReloadWorkRecordAsync" locked="locked" />
                            </div>

                            <div class="tab-pane fade @(activeTab == "accessMovementTab" ? "show active" : "")" id="accessMovementTab">
                                <CreateEditWorkRecordAccessMovementTab employeeAccessControlSwipes="employeeAccessControlSwipes"
                                                                       EmployeeId="EmployeeId" shiftDate="shiftDate" />

                            </div>
                        </div>

                    </div>


                </div>
                <!-- Footer-->
                <div class="modal-footer bg-white mt-auto" style="padding-top: 1rem;">
                    <button type="button" class="btn_modal-close body-medium" data-bs-dismiss="modal">Cancel</button>
                </div>

            </EditForm>
        </div>
    </div>
</div>

<CreateEditWorkRecordNotesTabModel @ref=createEditWorkRecordNotesTabModelRef isSubmitting="@isSubmitting" OnSubmit="OnNotesSaveAsync" />
@code {
    public List<EmployeeAccessControlSwipes> employeeAccessControlSwipes { get; set; } = new();
    public int EmployeeId;
    public DateTime shiftDate;
    public int employeeShiftId;
    [Parameter] public int tagId { get; set; } = new();
    [Parameter] public List<Employee> employees { get; set; } = new();
    [Parameter] public List<Tag> tagList { get; set; } = new();
    public bool late;
    public bool verified;
    public bool locked;

    private CreateEditWorkRecordNotesViewModel createEditWorkRecordsNotesModel = new()
    {
        WorkDetails = new WorkRecordAllDetails() 
    };

    private string? activeTab;
    private void OnTabClick(string workRecordsTab)
    {
        activeTab = workRecordsTab;
    }

    public async Task ShowModal(CreateEditWorkRecordNotesViewModel model)
    {
        createEditWorkRecordsNotesModel = model;
        EmployeeId = model.EmployeeId;
        shiftDate = model.ShiftDate;
        employeeShiftId = model.WorkDetails.EmployeeShiftId;
        late = model.WorkDetails.Late;
        verified = model.WorkDetails.Verified;
        locked = model.WorkDetails.Locked;

        activeTab = "workRecordsTab";
        await JS.InvokeVoidAsync("showModal", "workRecordNotesModel");
        StateHasChanged();
    }


    private string GetEmployeeImage()
    {
        var base64 = createEditWorkRecordsNotesModel?.WorkDetails?.EmployeePhotoBase64;

        if (!string.IsNullOrWhiteSpace(base64))
            return $"data:image/png;base64,{base64}";

        return "avtar.png";
    }

    <!-- Tag change -->
    private async Task OnTagChanged(ChangeEventArgs e)
    {
        int companyId = await UserContextService.GetCompanyIdAsync(AuthenticationStateProvider);
        tagId = int.Parse(e.Value!.ToString()!);

        //reload employees based on tag
        employees = await WorkRecordNotesService.GetEmployeeByTag2Async(new ParameterList
            {
                TagId = tagId,
                CompanyId = companyId
            });

        EmployeeId = employees.FirstOrDefault()?.Id ?? 0;

        await ReloadWorkRecordAsync();
    }

    <!-- Employee change -->
    private async Task OnEmployeeChanged(ChangeEventArgs e)
    {
        EmployeeId = int.Parse(e.Value!.ToString()!);

        await ReloadWorkRecordAsync();
    }

    private async Task ReloadWorkRecordAsync()
    {
        SpinnerService.Show();
        try
        {
            var newWorkRecordDetails = await WorkRecordNotesService.GetWorkRecordAllDetailsAsync(EmployeeId, 0, shiftDate);

            createEditWorkRecordsNotesModel.WorkDetails = newWorkRecordDetails;

            createEditWorkRecordsNotesModel.WorkDetails.WorkRecords = newWorkRecordDetails.WorkRecords.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.RealClockings = newWorkRecordDetails.RealClockings.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.EmployeeShifts = newWorkRecordDetails.EmployeeShifts.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.Overtime = newWorkRecordDetails.Overtime.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.Absence = newWorkRecordDetails.Absence.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.Exceptions = newWorkRecordDetails.Exceptions.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.ExceptionalItems = newWorkRecordDetails.ExceptionalItems.ToList();
            createEditWorkRecordsNotesModel.WorkDetails.Notes = newWorkRecordDetails.Notes;

            verified = newWorkRecordDetails.Verified;
            

            locked = newWorkRecordDetails.Locked;
            late = newWorkRecordDetails.Late;
            
            employeeShiftId = newWorkRecordDetails.EmployeeShiftId;
            //shiftDate = newWorkRecordDetails.ShiftDate;
            EmployeeId = newWorkRecordDetails.EmployeeId;

            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            SpinnerService.Hide();
        }
    }

    <!-- Previous next nad today button -->
    private async Task PreviousDay()
    {
        shiftDate = shiftDate.AddDays(-1);
        await ReloadWorkRecordAsync();
    }

    private async Task NextDay()
    {
        shiftDate = shiftDate.AddDays(1);
        await ReloadWorkRecordAsync();
    }

    private async Task Today()
    {
        shiftDate = DateTime.UtcNow.Date;
        await ReloadWorkRecordAsync();
    }


    //Notes 
    private CreateEditWorkRecordNotesViewModel createEditWorkRecordNotesViewModel { get; set; } = new();
    public bool isSubmitting { get; set; }

    CreateEditWorkRecordNotesTabModel? createEditWorkRecordNotesTabModelRef;
    public async Task CreateEditNotes()
    {
        SpinnerService.Show();
        //var notes = new List<WorkRecordNote>();
        try
        {
            // var notes = await WorkRecordNotesService.GetWorkRecordNotesAsync(EmployeeId, shiftDate);
            // var workRecordNotesViewModel = new CreateEditWorkRecordNotesViewModel
            // {
            //    Notes = notes.Notes
            // };

            var notes = await WorkRecordNotesService.GetWorkRecordNotesAsync(EmployeeId, shiftDate);

            notes.WorkDetails = await WorkRecordNotesService.GetWorkRecordAllDetailsAsync(EmployeeId, 0, shiftDate);

            await createEditWorkRecordNotesTabModelRef!.ShowModal(notes);
        }
        finally
        {
            SpinnerService.Hide();
            //await ReloadWorkRecordAsync();
        }
    }

    public async Task OnNotesSaveAsync(CreateEditWorkRecordNotesViewModel model)
    {
        isSubmitting = true;
        //await InvokeAsync(StateHasChanged);
        var companyId = await UserContextService.GetCompanyIdAsync(AuthenticationStateProvider);
        var userId = await UserContextService.GetUserIdAsync(AuthenticationStateProvider);
        try
        {
            var notes = new WorkRecordNote
            {
                Id = model.Id,
                EmployeeId = EmployeeId,
                ShiftDate = shiftDate,
                Notes = model.Notes,
                CreatedDate = DateTime.Now,

                CompanyId = companyId,
                UpdatedByUserId = userId,
                UpdatedDate = Helper.GetDateTimeNow()
            };
            if (model.Id == 0)
            {
                notes.CreatedByUserId = userId;
                notes.CreatedDate = Helper.GetDateTimeNow();
            }
            var success = await WorkRecordNotesService.SaveWorkRecordNotesAsync(notes);
            if (success)
            {
               
                isSubmitting = false;
                await JS.InvokeVoidAsync("hideModal", "workRecordNotesNotesModel");
                ToastService.Show("Note saved successfully!", ToastType.Success);
               
            }
            else
            {
                ToastService.Show("Failed to save note", ToastType.Danger);
            }
        }
        finally
        {
            await ReloadWorkRecordAsync();
            await InvokeAsync(StateHasChanged);
        }
    }
}
