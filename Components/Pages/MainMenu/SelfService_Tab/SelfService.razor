@page "/selfservice"

<!--Profile card and clockin clockout summary-->
<style>

    .selfservice-container {
        padding: 10px;
    }

    .welcome-text {
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 22px;
        margin-top: -8px;
    }


    /*  Profile card */
    .profile-wrapper {
        display: grid;
        gap: 20px;
        /* grid-template-columns: minmax(280px, 340px) 1fr; */
        /* grid-template-columns: minmax(280px, 340px) 2fr 1fr; */
        /*  grid-template-columns: 331px 337px 447px; */
        /* grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); */
        grid-template-columns: 1.2fr 1.3fr 1.4fr;
        width: 100%;
    }

    .profile-top {
        display: flex;
        gap: 24px;
        align-items: center;
    }

    /* Name and detail */
    .profile-card {
        background: white;
        padding: 18px;
        border-radius: 16px;
        /* display: flex; */
        flex-direction: column;
        gap: 14px;
        align-items: start;
        box-shadow: 0 10px 30px rgba(0,0,0,.05);
    }

    .profile-detail {
        margin-top: 4px;
        display: grid
    }

    .profile-card img {
        width: 68px;
        height: 70px;
        border-radius: 50%;
        margin-top: 7px;
        border: 2px solid gray;
    }

    .profile-card h3 {
        margin: 0;
        font-size: 17px;
    }

    .profile-card span {
        font-size: 15px;
        color: #262f42;
    }

    .profile-card a {
        font-size: 14px;
        color: #ff6e04;
        text-decoration: none;
    }


    /*  Clockin clock out button */
    .clockin-clockout-button {
        display: flex;
        gap: 24px;
        margin-top: 34px;
    }

        .clockin-clockout-button button {
            height: 35px;
        }

    .chip.green {
        background: #28a745;
        color: white;
        width: 100%;
    }

        .chip.green:hover {
            color: #28a745;
            background: white;
            border-color: #28a745;
        }

    .chip.red {
        background: #ee1c30;
        color: white;
        width: 100%;
    }

        .chip.red:hover {
            color: #ee1c30;
            background: white;
            border-color: #ee1c30;
        }

    /*  Clockin/Clockout summary */
    .clock-summary {
        background: white;
        padding: 18px 20px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.05);
    }

        .clock-summary h4 {
            font-size: 14px;
            color: #35383e;
            margin-bottom: 8px;
            font-weight: 600;
        }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 3px;
        font-size: 14px;
    }

        .summary-row span {
            color: #6b7280;
        }

    .status strong {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
    }

    .status-in {
        background: #dcfce7;
        color: #166534;
        margin-right: -7px;
    }

    .status-out {
        background: #fee2e2;
        color: #991b1b;
        margin-right: -7px;
    }

</style>

<!--Work button(start break/end break)-->
<style>
    .work-button {
        background: white;
        padding: 18px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.05);
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
    }

        /* Make everything equal */
        .work-button > button,
        .work-button > select {
            width: 100%;
            height: 35px;
            box-sizing: border-box;
        }

    /* Buttons */
    .chip {
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
    }

        .chip:hover {
            color: black;
            border-color: black;
            background: white;
        }

    .input-select select {
        border: 1px solid #ccc;
        padding: 8px 12px;
        border-radius: 999px;
        height: 35px !important;
        width: 100% !important;
        text-align: center !important;
        background: white;
    }

        .input-select select:focus {
            outline: none;
            border-color: black;
        }

        .input-select select option:checked {
            color: #333;
            font-weight: bold;
        }

    .input-select select {
        color: #333; /* selected text color */
        font-size: 14px;
        font-weight: 500;
        text-align: center;
    }

    .form-select {
        padding: 0px !important;
    }
</style>

<!--Holiday/ Sick/ Absence Card-->
<style>
    /* Holiday/ Sick/ Absence Card */
    .stat-card {
        position: relative;
        height: 100%;
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

        .stat-card::after {
            content: "";
            position: absolute;
            top: 15px;
            right: 15px;
            width: 55px;
            height: calc(100% - 30px);
            border-radius: 8px;
        }

        .stat-card h1 {
            font-size: 32px;
            margin-top: -10px;
            font-weight: 600;
        }

    /* Borders */
    .holiday {
        border-left: 8px solid #4CAF50;
    }

    .sick {
        border-left: 8px solid #FFB74D;
    }

    .absence {
        border-left: 8px solid #E57373;
    }

    .stat-card.holiday::after {
        background-color: #4CAF50;
    }

    .sick::after {
        background: #FFB74D;
    }

    .absence::after {
        background: #E57373;
    }


    /* Buttons */
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .action-btn {
        /*  background: #546f9b; */
        background: #031A7F;
        color: white;
        padding: 5px 14px !important;
        border-radius: 8px !important;
        border: none !important;
        cursor: pointer !important;
        height: 35px !important;
        text-align: center !important;
    }

        .action-btn:hover {
            background: #02145f;
        }
</style>

<!--Onboarding-->
<style>
    /* Onboarding */
    .onboarding-card {
        display: flex;
        justify-content: space-between;
        background: #FFFCF5;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .form-control {
        height: 35px !important;
    }

    .selfService-heading {
        font-weight: 600;
        font-size: 20px;
    }
</style>

<!-- Custome Table-->
<style>
    /*  Custome Table */
    .custom-table-wrapper {
        max-height: 380px;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    /* Table width */
    .custom-table {
        width: 100%;
        margin-bottom: 0;
        font-weight: 300 !important;
        font-size: 12px !important; /*Changed */
    }

        /* Sticky header */
        .custom-table thead th {
            font-size: 12px !important; /*Changed */
            height: 12px !important; /*Changed */
        }

        /*  row height */
        .custom-table tbody tr td {
            height: 8px !important; /*Changed */
        }

        .custom-table tbody tr td {
            padding: 0.35rem !important;
        }
</style>

@* <!--Timesheet table color -->
<style>
    /* Timesheet table color */

    .clsbold {
        font-weight: 700 !important;
        color: #0C111D !important;
    }

    .boldText {
        font-weight: bold;
        color: #333 !important;
    }

    tr.bg-holiday td {
        background-color: yellow;
    }

    tr.bg-bankholiday td {
        background-color: lightyellow !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-sick td {
        background-color: cyan !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-absence td {
        background-color: magenta !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidayrequest td {
        background-color: orange !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidaydeclined td {
        background-color: coral !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rostershift td {
        background-color: lightgreen !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rest td {
        background-color: white !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-scheduledshift td {
        background-color: lightgreen !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-workshift td {
        background-color: #33cc33 !important;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-lateness td {
        background-color: red;
    }

    tr.bg-excludeshift td {
        background-color: lightgray;
    }

    tr.bg-excludeactualshift td {
        background-color: #b3b3b3;
    }

    tr.bg-accessdenied td {
        background-color: red;
    }
</style>
 *@

@*  <style>
    /* Timesheet table color and typography */

    .clsbold {
        font-weight: 600 !important;
        color: #0C111D !important; /* Dark almost black */
    }

    .boldText {
        font-weight: bold;
        color: #333 !important;
    }

    /* Timesheet row backgrounds with soft, accessible colors */

    tr.bg-holiday td {
        background-color: #DFF0D8; /* Soft green */
        color: #3C763D;
    }

    tr.bg-bankholiday td {
        background-color: #FCF8E3; /* Light warm yellow */
        color: #8A6D3B;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-sick td {
        background-color: #D9EDF7; /* Soft blue */
        color: #31708F;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-absence td {
        background-color: #F2DEDE; /* Soft red/pink */
        color: #A94442;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidayrequest td {
        background-color: #FCE5CD; /* Light orange */
        color: #B9770E;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidaydeclined td {
        background-color: #F5C6CB; /* Light coral/pink */
        color: #7F2A2A;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rostershift td,
    tr.bg-scheduledshift td {
        background-color: #E6F2FF; /* Very light blue */
        color: #004085;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rest td {
        background-color: white !important;
        color: #333;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-workshift td {
        background-color: #C8E6C9; /* Light green */
        color: #256029;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-lateness td,
    tr.bg-accessdenied td {
        background-color: #F8D7DA; /* Light red */
        color: #721C24;
    }

    tr.bg-excludeshift td {
        background-color: #F0F0F0; /* Very light gray */
        color: #555;
    }

    tr.bg-excludeactualshift td {
        background-color: #D6D6D6; /* Medium gray */
        color: #444;
    }

    /* General table text style for readability */
    table tbody tr td {
        padding: 0.5rem 1rem;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.9rem;
    }

    /* Optional: subtle hover effect on rows */
    table tbody tr:hover {
        background-color: #f1f5f9;
        cursor: default;
    }
</style> *@

<style>
    /* Timesheet row colors with border left and text color */

    tr.bg-holiday td {
        background-color: #D6E9C6;
        border-left: 5px solid #AED581;
        color: #33691E;
    }

    tr.bg-bankholiday td {
        background-color: #FFF9C4;
        border-left: 5px solid #FFF176;
        color: #F9A825;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-sick td {
        background-color: #B3E5FC;
        border-left: 5px solid #4FC3F7;
        color: #01579B;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-absence td {
        background-color: #FFCDD2;
        border-left: 5px solid #EF9A9A;
        color: #B71C1C;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidayrequest td {
        background-color: #FFE0B2;
        border-left: 5px solid #FFB74D;
        color: #E65100;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-holidaydeclined td {
        background-color: #F8BBD0;
        border-left: 5px solid #F48FB1;
        color: #880E4F;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rostershift td,
    tr.bg-scheduledshift td {
        background-color: #E3F2FD;
        border-left: 5px solid #90CAF9;
        color: #0D47A1;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-rest td {
        background-color: #FFFFFF !important;
        color: #424242;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-workshift td {
        background-color: #C8E6C9;
        border-left: 5px solid #81C784;
        color: #2E7D32;
        -webkit-print-color-adjust: exact !important;
    }

    tr.bg-lateness td,
    tr.bg-accessdenied td {
        background-color: #FFEBEE;
        border-left: 5px solid #EF5350;
        color: #C62828;
    }

    tr.bg-excludeshift td {
        background-color: #F5F5F5;
        border-left: 5px solid #BDBDBD;
        color: #616161;
    }

    tr.bg-excludeactualshift td {
        background-color: #EEEEEE;
        border-left: 5px solid #9E9E9E;
        color: #424242;
    }

    /* General text styles */
    .clsbold {
        font-weight: 700 !important;
        color: #0C111D !important;
    }

    .boldText {
        font-weight: bold;
        color: #333 !important;
    }

    table tbody tr td {
        padding: 0.5rem 1rem;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.9rem;
    }

    /* Optional hover effect */
    table tbody tr:hover {
        background-color: #f5f5f5;
        cursor: default;
    }

</style>

<!--holiday request table button-->
<style>
    /*  holiday request table button */
    .status-btn {
        display: inline-block;
        padding: 4px 14px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
        min-width: 95px;
        text-align: center;
    }

    /* Requested → Pending */
    .status-requested {
        background-color: #FEF3C7;
        color: #92400E;
    }

    /* Declined → Negative */
    .status-declined {
        background-color: #FEE2E2;
        color: #991B1B;
    }

    /* Authorised → Approved */
    .status-authorised {
        background-color: #DCFCE7;
        color: #166534;
    }
</style>


<div class="selfservice-container">

    <div class="welcome-text">
        Welcome @employee?.Forename
    </div>


    <!-- Clock Timeline -->
    <div class="profile-wrapper">

        <!-- Profile -->
        <div class="profile-card">
            @if (employee != null)
            {
                <div class="profile-top">
                    <img src="@(string.IsNullOrEmpty(employee?.PhotoBase64) ? "/avtar.png" : $"data:image/png;base64,{employee.PhotoBase64}")" class="profile-img" />
                    <div class="profile-detail">
                        <h3><strong>@employee?.FullName</strong></h3>
                        <span>@employee?.JobTitle</span>
                        <a href="/employee"><strong>Go to Profile</strong></a>
                    </div>
                </div>
                <div class="clockin-clockout-button">
                    <button class="chip green" @onclick="OnClickClockedIn"> <i class="fa-solid fa-clock"></i>&nbsp;&nbsp Clock In</button>
                    <button class="chip red" @onclick="OnClickClockOut"><i class="bi bi-stop-circle-fill "></i>&nbsp;&nbsp Clock Out</button>
                </div>
            }
        </div>

        <!-- Work Buttons -->
        <div class="work-button">
            <button class="chip" @onclick="OnClickStartBreak">  <i class="fa-solid fa-utensils "></i>&nbsp;&nbsp Start Break</button>
            <button class="chip" @onclick="OnClickEndBreak"><i class="fa-solid fa-person-running"></i>&nbsp;&nbsp End Break</button>

            <button class="chip" @onclick="OnClickChangeActivity"><i class="fa-solid fa-wrench"></i>&nbsp;&nbsp Activity</button>
            <button class="chip" @onclick="OnClickChangeCostCentre"> <i class="fa-solid fa-exchange-alt"></i>&nbsp;&nbsp Cost centre</button>

            <div class="input-select">
                <InputSelect @bind-Value="activityListId">
                    @if (ActivityList != null)
                    {
                        @foreach (var activity in ActivityList)
                        {
                            <option value="@activity.Id">@activity.Name</option>
                        }
                    }
                </InputSelect>
            </div>

            <div class="input-select">
                <InputSelect @bind-Value="selectedCostCentreId">
                    @if (CostCentresList != null)
                    {
                        @foreach (var costCentre in CostCentresList)
                        {
                            <option value="@costCentre.Id">@costCentre.Name</option>
                        }
                    }
                </InputSelect>
            </div>
        </div>


        <!-- Today Summary -->
        <div class="clock-summary">
            <h4>
                @(
                   selectedDate.Date == DateTime.Today
                   ? "Today's activity"
                   : $"Activity – {selectedDate.ToString("dd MMM yyyy")}"
                 )
            </h4>


            <div class="summary-row">
                <span>Clock In</span>
                <strong>@TodayClockIn</strong>
            </div>

            <div class="summary-row">
                <span>Clock Out</span>
                <strong>@TodayClockOut</strong>
            </div>

            <div class="summary-row">
                <span>Worked</span>
                <strong>@TodayWorked</strong>
            </div>

            <div class="summary-row status">
                <span>Status</span>
                <strong class="@StatusClass">@TodayStatus</strong>
            </div>
        </div>

    </div>

    <!-- Stats + Actions -->
    <div class="dashboard mt-3">
        <div class="row">
            <!-- Left: Stats -->
            <div class="col-md-9">
                <div class="row stats">
                    <div class="col-md-4">
                        <div class="stat-card holiday">
                            <p>Holiday</p>
                            <h1>@Holidaybooked/@Holidaytotal</h1>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="stat-card sick">
                            <p>Sick</p>
                            <h1>@Sickbooked/@Sicktotal</h1>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="stat-card absence">
                            <p>Absence</p>
                            <h1>@Absencebooked/@Absencetotal</h1>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Quick actions -->
            <div class="col-md-3 quick-actions">

                <button class="action-btn"> Organisation Chart</button>
                <button class="action-btn"> Request Holiday / Absence</button>
                <button class="action-btn"> Visitors / Contractors</button>

            </div>
        </div>
    </div>

    <!--Onboarding-->
    @if (employeeWorkflowProgress != null)
    {
        <div class="selfService-heading mt-4">Onboarding</div>
        <div class="onboarding-card mt-2">
            <div>
                <i class="bi bi-exclamation-circle text-danger fs-5 me-2"></i>   Workflow Status : <strong>@employeeWorkflowProgress?.AssignmentsCompleted / @employeeWorkflowProgress?.TotalAssignments tasks completed </strong>
            </div>
            <button class="chip ">  Take Action </button>
        </div>
    }


    <!--Timesheet-->
    <div class="d-flex align-items-center justify-content-between mt-3">
        <div class="selfService-heading">Timesheet</div>

        <div class="d-flex align-items-center gap-2">
            <InputDate Value="selectedDate"
                       ValueChanged="@(async (DateTime newDate) => await OnDateChanged(newDate))"
                       ValueExpression="() => selectedDate"
                       class="form-control"
                       style="width: 180px;" />

        </div>
    </div>

    <div class="mt-2 table-responsive custom-table-wrapper">
        <table class="table table-hover table-bordered align-middle  custom-table">
            <thead>
                <tr>
                    <th style="width: 4%;">Day</th>
                    <th style="width:8%">Date</th>
                    <th style="width:8%">Roster Shift</th>
                    <th style="width:8%">Actual Shift</th>
                    <th style="width:8%">Start Time</th>
                    <th style="width:8%">End Time</th>
                    <th style="width:8%">Hours</th>
                    <th style="width:8%">Contractrd</th>
                    <th style="width:8%">Variance</th>
                    <th style="width:8%">Overtime</th>
                    <th style="width:8%">Status</th>
                    <th style="width:8%">Holiday Slot</th>
                </tr>
            </thead>

            <tbody>
                @{
                    int index = 0;
                    int totalCount = weeklySummaries.Count;
                }

                @foreach (var row in weeklySummaries)
                {
                    var rowClasses = new List<string>();
                    string clsbold = "";

                    // Apply bold text if RosterShiftCode exists
                    if (!string.IsNullOrWhiteSpace(row.RosterShiftCode) && row.RosterShiftCode != "-")
                    {
                        rowClasses.Add("boldText");
                    }

                    // Background color logic
                    if (!string.IsNullOrEmpty(row.Day))
                    {
                        switch (row.AbsenceTypeId)
                        {
                            case 1: rowClasses.Add("bg-holiday"); break;
                            case 2: rowClasses.Add("bg-sick"); break;
                            case 3: rowClasses.Add("bg-absence"); break;
                            case 4: rowClasses.Add("bg-holidayrequest"); break;
                            case 5: rowClasses.Add("bg-holidaydeclined"); break;
                            case 6: rowClasses.Add("bg-bankholiday"); break;
                            default:
                                if (row.IsLate == true)
                                    rowClasses.Add("bg-lateness");
                                else if (!string.IsNullOrEmpty(row.EmployeeShiftId?.ToString()) && row.EmployeeShiftId.ToString() != "-")
                                    rowClasses.Add("bg-workshift");
                                else if (row.ContractedDisplay == "00:00" || row.ContractedDisplay == "0:00")
                                    rowClasses.Add("bg-rest");
                                else if (
                                (!string.IsNullOrEmpty(row.RosterShiftCode) && row.RosterShiftCode != "-") ||
                                (!string.IsNullOrEmpty(row.ShiftCode) && row.ShiftCode != "-")
                                )
                                    rowClasses.Add("bg-rostershift");
                                break;
                        }
                    }

                    // Make last row bold
                    if (index == totalCount - 1)
                    {
                        clsbold = "clsbold";
                    }

                    <tr class="@string.Join(" ", rowClasses)">
                        <td class="cldtext @clsbold">@((row.Day) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.StartDateDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((string.IsNullOrWhiteSpace(row.RosterShiftCode)) ? "-" : row.RosterShiftCode)</td>
                        <td class="cldtext @clsbold">@(string.IsNullOrWhiteSpace(row.ShiftCode) ? "-" : row.ShiftCode)</td>
                        <td class="cldtext @clsbold">@((row.StartTimeDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.EndTimeDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.HoursDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.ContractedDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.VarianceDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.OvertimeDisplay) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.Status) ?? "-")</td>
                        <td class="cldtext @clsbold">@((row.HolidayThresholdDetailsDisplay) ?? "-")</td>
                    </tr>
                    index++;
                }
            </tbody>

        </table>
    </div>

    <!--Announcements-->
    <div class="selfService-heading mt-3">Announcements</div>

    <div class="mt-2 table-responsive custom-table-wrapper">
        <table class="table table-hover table-bordered align-middle  custom-table">
            <thead>
                <tr>
                    <th style="width: 20%; align-items:start">Mesage</th>
                    <th style="width:20%">Sent by</th>
                    <th style="width:20%"> Sent at</th>
                    <th style="width:20%"> Document</th>
                    <th style="width:20%">Archive</th>

                </tr>
            </thead>

            <tbody>
                @if (employeeAnnouncements.Any())
                {
                    @foreach (var announcement in employeeAnnouncements)
                    {
                        <tr>
                            <td>@announcement.Message</td>
                            <td>@announcement.Username</td>
                            <td>@announcement.CreatedDateDisplay</td>
                            @*  <td>
                            @if (!string.IsNullOrEmpty(announcement.IsDocument) && announcement.DocumentId.HasValue)
                            {
                                <a href="@($"/employeePayrollDocument/download/{announcement.DocumentId}")">@announcement.DocumentName</a>
                            }
                            else
                            {
                                <span>No Document</span>
                            } 
                        <td>*@
                            @*  <td>
                            @if (announcement.)
                            {
                                <span>Yes</span>
                            }
                            else
                            {
                                <span>No</span>
                            } *@
                        </tr>
                    }
                }

                else
                {
                    <tr>
                        <td colspan="5" class="text-center">No Announcements found.</td>
                    </tr>

                }
            </tbody>

        </table>
    </div>


    <!--Holiday Requests-->
    <div class="selfService-heading mt-3">Holiday Requests</div>

    <div class="mt-2 table-responsive custom-table-wrapper">
        <table class="table table-hover table-bordered align-middle  custom-table">
            <thead>
                <tr>
                    <th style="width: 20%; align-items:start">Holiday Date</th>
                    <th style="width:20%">Holiday type</th>
                    <th style="width:20%"> Status</th>
                    <th style="width:20%"> Requested at</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var holiday in employeeHolidays)
                {
                    <tr>
                        <td>@holiday.AbsenceDateDisplay</td>
                        <td>@holiday.AbsenceName</td>
                        @* <td>@holiday.StatusDisplay</td> *@
                        <td>
                            <span class="status-btn @GetStatusClass(holiday.Status)">
                                @holiday.StatusDisplay
                            </span>
                        </td>

                        <td>@holiday.HolidayRequestedAtDisplay</td>
                    </tr>
                }
            </tbody>

        </table>
    </div>

    <!--Shift notificetion table-->
    <div class="selfService-heading mt-3">Shift Notifications</div>

    <div class="mt-2 table-responsive custom-table-wrapper">
        <table class="table table-hover table-bordered align-middle  custom-table">
            <thead>
                <tr>
                    <th style="width: 10%; align-items:start">Id</th>
                    <th style="width:15%">Shift code</th>
                    <th style="width:15%"> Shift name</th>
                    <th style="width:15%">Shift date </th>
                    <th style="width:15%"> Sent by</th>
                    <th style="width:15%">Sent at </th>
                    <th style="width:15%">Status </th>

                </tr>
            </thead>

            <tbody>
                @if (employeeShiftNotifications.Any())
                {

                    @foreach (var shiftNotification in employeeShiftNotifications)
                    {
                        <tr>
                            <td>@shiftNotification.Id</td>
                            <td>@shiftNotification.ShiftCode</td>
                            <td>@shiftNotification.ShiftName</td>
                            <td>@shiftNotification.ShiftDateDisplay</td>
                            <td>@shiftNotification.Username</td>
                            <td>@shiftNotification.CreatedDate</td>
                            <td>@shiftNotification.StatusDisplay</td>

                        </tr>
                    }
                }

                else
                {
                    <tr>
                        <td colspan="5" class="text-center">No Notification found.</td>
                    </tr>
                }
            </tbody>

        </table>
    </div>

    <div class="col-md-12">
        <div class="row ">
            <div class="col-4">
                <!--Payslip-->
                <div class="selfService-heading mt-3">Payslip</div>

                <div class="mt-2 table-responsive custom-table-wrapper">
                    <table class="table table-hover table-bordered align-middle  custom-table">
                        <thead>
                            <tr>
                                <th style="width: 33%; align-items:start">CreatedDate</th>
                                <th style="width:34%">Amount</th>
                                <th style="width:33%"> View payslip</th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (employeePayrollPayments.Any())
                            {
                                @foreach (var payrollPayment in employeePayrollPayments)
                                {
                                    <tr>
                                        <td>@payrollPayment.CreatedDate</td>
                                        <td>@payrollPayment.Amount</td>
                                        <td>@payrollPayment.ShapePaymentId</td>
                                    </tr>
                                }
                            }
                            else
                            {
                            <td colspan="5" class="text-center">No Payslip found.</td>
                        }
                        </tbody>

                    </table>
                </div>
            </div>

            <div class="col-8">
                <!--Other Pay Data-->
                <div class="selfService-heading mt-3">Other Pay Data</div>

                <div class="mt-2 table-responsive custom-table-wrapper">
                    <table class="table table-hover table-bordered align-middle  custom-table">
                        <thead>
                            <tr>
                                <th style="width: 30%; align-items:start">Created date</th>
                                <th style="width:20%">Financial Year</th>
                                <th style="width:50%"> Generate Document</th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (employeePayrollDocument.Any())
                            {
                                @foreach (var payrollDocument in employeePayrollDocument)
                                {
                                    <tr>
                                        <td>@payrollDocument.DocumentDisplay</td>
                                        <td>
                                            <div class="input-select">
                                                <select class="form-select form-select-sm"
                                                        @bind="payrollDocument.SelectedYear">
                                                    @foreach (var year in payrollDocument.Years)
                                                    {
                                                        <option value="@year">@year</option>
                                                    }
                                                </select>
                                            </div>
                                        </td>

                                        <td>
                                            <button class="btn"
                                                    @onclick="() => CheckP60(payrollDocument.DocumentDisplay)"
                                                    title="Generate">
                                                <i class="fa fa-file-pdf text-danger"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

@code {
    private List<UserSelfServiceAccess> selfServiceAccess = new();
    private Employee employee;
    private List<Activity> ActivityList;
    private List<CostCentre> CostCentresList;
    private int activityListId;
    private int selectedCostCentreId;

    private List<DashboardChartData> chartData;
    private decimal Holidaybooked;
    private decimal Holidaytotal;
    private int Holidaypercentage;

    private decimal Sickbooked;
    private decimal Sicktotal;
    private int Sickpercentage;

    private decimal Absencebooked;
    private decimal Absencetotal;
    private int Absencepercentage;
    private EmployeeWorkflowProgress? employeeWorkflowProgress;

    private DateTime selectedDate;
    //private string startDate = DateTime.Now.ToString("dd/MM/yyyy");
    private List<WeeklySummary> weeklySummaries = new();
    private List<AbsenteeRecord> employeeHolidays = new();
    private List<EmployeeAnnouncement> employeeAnnouncements = new();
    private List<EmployeeShiftNotification> employeeShiftNotifications = new();
    private List<ShapePayment> employeePayrollPayments = new();
    private List<SelfServiceEmployeePayrollDocuments> employeePayrollDocument = new();

    private int userId;
    private int companyId;
    private int employeeId;
    // private int employeeId = 36331;

    // Today Summary
    private WeeklySummary? Today =>
   weeklySummaries?.FirstOrDefault(x => x.ShiftDate?.Date == selectedDate.Date);
    private string TodayClockIn =>
    Today?.StartTime?.ToString("hh:mm tt") ?? "--";
    private string TodayClockOut =>
    Today?.EndTime?.ToString("hh:mm tt") ?? "--";

    private string TodayWorked =>
    Today != null ? Today.HoursDisplay : "--";

    private string TodayStatus =>
    Today?.EndTime == null && Today?.StartTime != null
    ? "Clocked In"
    : Today?.EndTime != null
    ? "Clocked Out"
    : "Not Started";

    private string StatusClass =>
    TodayStatus == "Clocked In" ? "status-in" : "status-out";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            SpinnerService.Show();
            //selectedDate = DateTime.Today;
            selectedDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);

            await LoadDataAsync();
        }

        finally
        {
            SpinnerService.Hide();
        }
    }

    private async Task LoadDataAsync()
    {
        userId = await UserContextService.GetUserIdAsync(AuthenticationStateProvider);
        companyId = await UserContextService.GetCompanyIdAsync(AuthenticationStateProvider);
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;


        employeeId = await UserContextService.GetEmployeeIdAsync(AuthenticationStateProvider);
        selfServiceAccess = await SelfServices.GetUserSelfServiceAccessAsync(userId);

        var parameterList = new ParameterList
        {
            CompanyId = companyId,
            EmployeeId = employeeId,
            Id = employeeId,
        };

        employee = await SelfServices.GetEmployeeByIdAsync(parameterList);
        if (employee != null && employee.EmployeePhoto?.Photo != null)
        {
            employee.PhotoBase64 = Convert.ToBase64String(employee.EmployeePhoto.Photo);
        }

        ActivityList = await SelfServices.GetActivitiesAsync(companyId);
        CostCentresList = await SelfServices.GetCostCentresAsync(companyId);

        employeeWorkflowProgress = await SelfServices.GetEmployeeWorkflowProgress(employeeId);
        employeeWorkflowProgress.AssignmentsCompleted = Convert.ToInt32(employeeWorkflowProgress.AssignmentsCompleted);
        employeeWorkflowProgress.TotalAssignments = Convert.ToInt32(employeeWorkflowProgress.TotalAssignments);

        // DateTime date = string.IsNullOrEmpty(startDate)
        // ? Helper.GetDateTimeNow()
        // : DateTime.Parse(startDate);
        // weeklySummaries = await SelfServices.GetSelfServiceEmployeeWeeklySummary(employeeId, companyId, date, user);
        weeklySummaries = await SelfServices.GetSelfServiceEmployeeWeeklySummary(employeeId, companyId, selectedDate, user);


        //chart data
        chartData = await SelfServices.GetSelfServiceEntitlementAsync(employeeId, companyId);
        if (chartData.Any())
        {
            Holidaybooked = Convert.ToInt32(chartData[0].Datasets[0].Data[0]);
            var Holidayremaining = Convert.ToInt32(chartData[0].Datasets[0].Data[1]);
            Holidaytotal = Holidaybooked + Holidayremaining;

            Holidaypercentage = Holidaytotal > 0 ? (int)Math.Round((Holidaybooked / Holidaytotal) * 100) : 0;

            Sickbooked = Convert.ToInt32(chartData[1].Datasets[0].Data[0]);
            var Sickremaining = Convert.ToInt32(chartData[1].Datasets[0].Data[1]);
            Sicktotal = Sickbooked + Sickremaining;

            Sickpercentage = Sicktotal > 0 ? (int)Math.Round((Sickbooked / Sicktotal) * 100) : 0;

            Absencebooked = Convert.ToInt32(chartData[2].Datasets[0].Data[0]);
            var Absenceremaining = Convert.ToInt32(chartData[2].Datasets[0].Data[1]);
            Absencetotal = Absencebooked + Absenceremaining;

            Absencepercentage = Absencetotal > 0 ? (int)Math.Round((Absencebooked / Absencetotal) * 100) : 0;
        }

        employeeHolidays = await SelfServices.GetEmployeeHolidayAsync(employeeId, companyId);
        employeeAnnouncements = await SelfServices.GetEmployeeAnnouncements(employeeId);
        employeeShiftNotifications = await SelfServices.GetEmployeeShiftNotificationsAsync(employeeId);
        employeePayrollPayments = await SelfServices.GetEmployeePayrollPaymentsAsync(employeeId, companyId);
        employeePayrollDocument = await SelfServices.GetEmployeePayrollDocumentsAsync(companyId);
    }

    <!-- TimeSheet Date Chnge-->
    private async Task OnDateChanged(DateTime newDate)
    {
        try
        {
            SpinnerService.Show();
            selectedDate = newDate;
        }
        finally
        {
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }
    private string GetStatusClass(int status)
    {
        return status switch
        {
            10 => "status-requested",
            20 => "status-declined",
            _ => "status-authorised"
        };
    }

    <!--ClockedIn and clocked out -->
    private int Clocked;
    private async Task OnClickClockedIn()
    {
        try
        {
            SpinnerService.Show();
            Clocked = 1;
            bool isClockedIn = await SelfServices.SubmitClocking(employeeId, "clockIn", 0);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} clocked in.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }
    private async Task OnClickClockOut()
    {
        try
        {
            SpinnerService.Show();
            Clocked = 2;
            bool isClockedOut = await SelfServices.SubmitClocking(employeeId, "clockOut", 0);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} clocked out.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }

    <!--Start break and End break -->
    private async Task OnClickStartBreak()
    {
        try
        {
            SpinnerService.Show();
            Clocked = 3;
            bool isStartBreak = await SelfServices.SubmitClocking(employeeId, "startBreak", 0);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} started break.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }
    private async Task OnClickEndBreak()
    {
        try
        {
            SpinnerService.Show();
            Clocked = 4;
            bool isEndBreak = await SelfServices.SubmitClocking(employeeId, "endBreak", 0);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} ended break.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }

    <!--Change activity and cost centre  -->
    private async Task OnClickChangeActivity()
    {
        try
        {
            SpinnerService.Show();
            bool isActivity = await SelfServices.SubmitClocking(employeeId, "changeActivity", activityListId);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} activity updated.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }
    private async Task OnClickChangeCostCentre()
    {
        try
        {
            SpinnerService.Show();
            bool isCostCentre = await SelfServices.SubmitClocking(employeeId, "changeCostCentre", selectedCostCentreId);
        }
        finally
        {
            await JS.InvokeVoidAsync("alert", $"{employee.FullName} cost centre updated.");
            await LoadDataAsync();
            SpinnerService.Hide();
        }
    }

    //Download P60 and PBIK 
    private bool? result;
    private async Task CheckP60(string type)
    {
        if (type == "P60")
        {
            string payrollDocumentYear = employeePayrollDocument[0].SelectedYear.Substring(0, 4);

            result = await SelfServices.CheckPayrollP60Async(companyId, employeeId, Convert.ToInt32(payrollDocumentYear));
            if (result == true)
            {
                var bytes = await SelfServices.GetPayrollP60(companyId, employeeId, Convert.ToInt32(payrollDocumentYear));

                if (bytes != null)
                {
                    string base64 = Convert.ToBase64String(bytes);
                    await JS.InvokeVoidAsync("downloadFile", base64, "P60.pdf");
                }
            }
            else if (result == false)
            {
                await JS.InvokeVoidAsync("alert", " No data available for the selected year.");
            }
        }
        else if (type == "PBIK")
        {
            string payrollDocumentYear = employeePayrollDocument[1].SelectedYear.Substring(0, 4);

            result = await SelfServices.CheckPayrollPBIKAsync(companyId, employeeId, Convert.ToInt32(payrollDocumentYear));
            if (result == true)
            {
                var bytes = await SelfServices.GetPayrollPBIK(companyId, employeeId, Convert.ToInt32(payrollDocumentYear));

                if (bytes != null)
                {
                    string base64 = Convert.ToBase64String(bytes);
                    await JS.InvokeVoidAsync("downloadFile", base64, "PBIK.pdf");
                }
            }
            else if (result == false)
            {
                await JS.InvokeVoidAsync("alert", " No data available for the selected year.");
            }
        }

    }

}